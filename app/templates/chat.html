{% extends 'base.html' %}

{% block title %}Chat{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-6 col-md-8 col-sm-10">
    <h1 class="mb-4">Chat with our AI Assistant</h1>
    <div id="chat-container">
      <div id="chat-messages">
        <!-- 示例：预先存在的一条机器人回答 -->
        <!-- 以后你可以动态追加多条记录 -->
        <div class="chat-message chatbot mb-3">
          <p class="chatbot-answer">这里是机器人生成的答案示例...</p>
          <!-- 内嵌反馈区域，初始状态 data-feedback-submitted 为 false -->
          <div class="feedback mt-2" data-feedback-submitted="false">
            <span>Rate this answer: </span>
            <button class="btn btn-sm btn-outline-warning me-1" onclick="submitFeedback(this, 1)">1★</button>
            <button class="btn btn-sm btn-outline-warning me-1" onclick="submitFeedback(this, 2)">2★</button>
            <button class="btn btn-sm btn-outline-warning me-1" onclick="submitFeedback(this, 3)">3★</button>
            <button class="btn btn-sm btn-outline-warning me-1" onclick="submitFeedback(this, 4)">4★</button>
            <button class="btn btn-sm btn-outline-warning" onclick="submitFeedback(this, 5)">5★</button>
            <span class="feedback-msg text-success ms-2"></span>
          </div>
        </div>
      </div>
      <!-- 聊天输入框及发送按钮 -->
      <form id="chat-form" class="d-flex mt-3">
        <input type="text" id="user-input" class="form-control" placeholder="Type your message here..." required>
        <button type="submit" class="btn btn-primary ms-2">Send</button>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  /**
   * 提交反馈，按钮点击时调用
   * @param {HTMLElement} button - 被点击的反馈按钮
   * @param {number} rating - 用户选择的星级（1～5）
   */
  async function submitFeedback(button, rating) {
    // 定位到当前反馈区域（feedback div）
    const feedbackBlock = button.parentElement;
    
    // 检查当前回答是否已经提交过反馈
    if (feedbackBlock.getAttribute('data-feedback-submitted') === 'true') {
      alert("你已经提交过反馈，不能重复提交。");
      return;
    }
    
    // 获取同一聊天记录中机器人回答的文本
    const chatbotAnswerElement = feedbackBlock.parentElement.querySelector('.chatbot-answer');
    const answerText = chatbotAnswerElement ? chatbotAnswerElement.innerText : "";
    if (!answerText) {
      alert("无法获取答案内容");
      return;
    }
    
    try {
      const response = await fetch('/feedback', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ rating: rating, answer: answerText })
      });
      const result = await response.json();
      if (response.ok) {
        // 设置属性标记已经提交过反馈
        feedbackBlock.setAttribute('data-feedback-submitted', 'true');
        // 显示“你的反馈已提交”的提示
        feedbackBlock.querySelector('.feedback-msg').innerText = "你的反馈已提交";
        // 禁用该反馈区域所有按钮，避免重复提交
        const buttons = feedbackBlock.querySelectorAll('button');
        buttons.forEach(btn => btn.disabled = true);
      } else {
        alert(result.error || '反馈提交失败');
      }
    } catch (error) {
      console.error('Feedback error:', error);
      alert('提交反馈时发生错误');
    }
  }

  /**
   * 示例：动态添加一条新的机器人回答及反馈区域
   * 你可以在聊天逻辑中调用该函数来生成新记录
   */
  function appendChatbotAnswer(answerText) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = "chat-message chatbot mb-3";
    
    // 构造答案内容
    const answerPara = document.createElement('p');
    answerPara.className = "chatbot-answer";
    answerPara.innerText = answerText;
    
    // 构造反馈区域
    const feedbackDiv = document.createElement('div');
    feedbackDiv.className = "feedback mt-2";
    feedbackDiv.setAttribute('data-feedback-submitted', 'false');
    feedbackDiv.innerHTML = `
      <span>Rate this answer: </span>
      <button class="btn btn-sm btn-outline-warning me-1" onclick="submitFeedback(this, 1)">1★</button>
      <button class="btn btn-sm btn-outline-warning me-1" onclick="submitFeedback(this, 2)">2★</button>
      <button class="btn btn-sm btn-outline-warning me-1" onclick="submitFeedback(this, 3)">3★</button>
      <button class="btn btn-sm btn-outline-warning me-1" onclick="submitFeedback(this, 4)">4★</button>
      <button class="btn btn-sm btn-outline-warning" onclick="submitFeedback(this, 5)">5★</button>
      <span class="feedback-msg text-success ms-2"></span>
    `;
    
    // 将答案和反馈区域添加到消息区
    messageDiv.appendChild(answerPara);
    messageDiv.appendChild(feedbackDiv);
    chatMessages.appendChild(messageDiv);
  }

  // 示例：模拟接收到机器人回答后动态添加记录
  // 你可以在发送用户消息后，根据聊天机器人生成的答案调用该函数
  // appendChatbotAnswer("这是新的机器人回答示例。");
</script>
{% endblock %}
